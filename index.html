<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pred Hold + Match Win</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body{margin:0;font-family:system-ui;background:#0b0f1f;color:#fff;padding:16px}
  h1{margin:0 0 12px;font-size:42px}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px}
  input{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
        background:rgba(0,0,0,.25);color:#fff;font-size:16px}
  #status{margin-top:10px;opacity:.85;font-size:13px;line-height:1.35}
  .wrap{margin-top:12px;border:1px solid rgba(255,255,255,.10);border-radius:16px;overflow:auto;display:none;
        max-height:70vh;background:rgba(0,0,0,.18)}
  table{border-collapse:collapse;min-width:980px;width:100%}
  th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);white-space:nowrap;vertical-align:middle}
  th{font-size:12px;opacity:.7;text-align:left;position:sticky;top:0;background:#101427}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .player{white-space:normal;font-weight:800}
  .copy{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);padding:6px 10px;border-radius:999px;color:#fff;cursor:pointer}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(0,0,0,.7);
         border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:999px;opacity:0;transition:.15s;pointer-events:none}
  .toast.show{opacity:1}
</style>
</head>
<body>
<h1>Pred Hold + Match Win</h1>

<div class="card">
  <input id="file" type="file" accept=".csv,text/csv" />
  <div id="status">Upload your file.</div>

  <div id="wrap" class="wrap">
    <table>
      <thead>
        <tr>
          <th>Copy</th>
          <th>Player</th>
          <th class="num">Odds</th>
          <th class="num">SPW%</th>
          <th class="num">RPW%</th>
          <th class="num">Pred Hold%</th>
          <th class="num">Match Win% (BO3)</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>

<div id="toast" class="toast">Copied</div>

<script>
const $=id=>document.getElementById(id);
const toast=m=>{const t=$("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),850)}

// --- parsing helpers ---
const hk=s=>String(s??"").trim().toLowerCase().replace(/%/g,"").replace(/[^a-z0-9]+/g,"");
const n=v=>{
  v=(v??"").toString().trim();
  if(!v) return NaN;
  v=v.replace("%","").replace(",",".");
  const x=+v;
  return Number.isFinite(x)?x:NaN;
};

async function parseFile(file){
  const parse = (delim)=>new Promise((resolve,reject)=>{
    Papa.parse(file,{header:true,skipEmptyLines:true,delimiter:delim,complete:resolve,error:reject});
  });
  let r = await parse(""); // auto
  if((r.meta?.fields||[]).length<=1) r = await parse("\t"); // TSV fallback
  return r;
}

// --- tennis math ---
// Hold% from point-win p (advantage game, deuce included)
function holdFromPoint(p){
  p = Math.max(0.001, Math.min(0.999, p));
  const q = 1 - p;
  const pre = Math.pow(p,4) * (1 + 4*q + 10*q*q);
  const reachDeuce = 20 * Math.pow(p,3) * Math.pow(q,3);
  const winFromDeuce = (p*p) / (1 - 2*p*q);
  return pre + reachDeuce * winFromDeuce; // 0..1
}
// predicted serve point-win p = mean(SPW_A, 1 - RPW_B)
function pServe(spwA, rpwB){
  return Math.max(0.001, Math.min(0.999, ((spwA/100) + ((100-rpwB)/100))/2 ));
}

// Iterative DP for set win from holds with 50/50 tiebreak.
// startServerA: 1 if A serves first, 0 if B serves first.
function setWinProbFromHolds(hA, hB, startServerA){
  const dp = new Map(); // key: "ga|gb|s" where s=1 if A serves next else 0
  const key = (ga,gb,s)=> `${ga}|${gb}|${s}`;
  dp.set(key(0,0,startServerA?1:0), 1);

  let win = 0;

  const terminal = (ga,gb)=>{
    if ((ga>=6 || gb>=6) && Math.abs(ga-gb)>=2) return ga>gb ? 1 : 0;
    if (ga===7) return 1;
    if (gb===7) return 0;
    return null;
  };

  for(let ga=0; ga<=7; ga++){
    for(let gb=0; gb<=7; gb++){
      for(let s=0; s<=1; s++){
        const prob = dp.get(key(ga,gb,s)) || 0;
        if(!prob) continue;

        const t = terminal(ga,gb);
        if(t !== null){ win += prob*t; continue; }

        if(ga===6 && gb===6){
          // tiebreak assumed 50/50
          win += prob*0.5;
          continue;
        }

        const pGameA = (s===1) ? hA : (1-hB); // if A serves -> hA, else A breaks with 1-hB
        const ns = 1 - s;

        dp.set(key(ga+1, gb, ns), (dp.get(key(ga+1,gb,ns))||0) + prob*pGameA);
        dp.set(key(ga, gb+1, ns), (dp.get(key(ga,gb+1,ns))||0) + prob*(1-pGameA));
      }
    }
  }
  return win; // 0..1
}

function matchWinBO3FromSet(pSet){
  return pSet*pSet*(3 - 2*pSet);
}

// --- UI ---
$("file").addEventListener("change", async (e)=>{
  const file=e.target.files?.[0];
  if(!file) return;

  $("status").textContent="Parsingâ€¦";
  $("wrap").style.display="none";
  $("tb").innerHTML="";

  try{
    const res = await parseFile(file);
    const fields = res.meta?.fields || [];
    if(!fields.length){ $("status").textContent="No headers found."; return; }

    const map=new Map(fields.map(f=>[hk(f),f]));
    const kPlayer = map.get("player") || map.get("name");
    const kOdds   = map.get("odds") || map.get("price");
    const kSPW    = map.get("spw");
    const kRPW    = map.get("rpw");

    if(!kPlayer || !kSPW || !kRPW){
      $("status").textContent=`Missing columns. Need Player, SPW, RPW. Found: ${fields.slice(0,12).join(" | ")}`;
      return;
    }

    // Clean rows: drop footer lines, keep only rows with numeric SPW/RPW
    const rows = (res.data||[]).map(r=>{
      const player=(r[kPlayer]??"").toString().trim();
      if(!player) return null;
      if(/^(surface|period|tour|match type|time)\s*:/i.test(player)) return null;
      const spw=n(r[kSPW]), rpw=n(r[kRPW]);
      if(!Number.isFinite(spw) || !Number.isFinite(rpw)) return null;
      const odds = kOdds ? n(r[kOdds]) : NaN;
      return {player,odds,spw,rpw};
    }).filter(Boolean);

    if(rows.length < 2){
      $("status").textContent=`Loaded ${rows.length} rows. Need at least 2 (a couplet).`;
      return;
    }

    // Build output by couplets (A,B), compute pred holds and match win
    const out = [];
    for(let i=0;i<rows.length-1;i+=2){
      const A=rows[i], B=rows[i+1];

      const pA = pServe(A.spw, B.rpw);
      const pB = pServe(B.spw, A.rpw);

      const hA = holdFromPoint(pA);
      const hB = holdFromPoint(pB);

      // set win A, average who serves first
      const sA = 0.5*setWinProbFromHolds(hA,hB,1) + 0.5*setWinProbFromHolds(hA,hB,0);
      const mA = matchWinBO3FromSet(sA);
      const mB = 1 - mA;

      out.push({...A, predHold: hA*100, matchWin: mA*100});
      out.push({...B, predHold: hB*100, matchWin: mB*100});
    }

    $("tb").innerHTML = out.map(r=>`
      <tr>
        <td><button class="copy" data-name="${encodeURIComponent(r.player)}">ðŸ“‹</button></td>
        <td class="player">${r.player}</td>
        <td class="num">${Number.isFinite(r.odds)?r.odds.toFixed(2):""}</td>
        <td class="num">${r.spw.toFixed(1)}</td>
        <td class="num">${r.rpw.toFixed(1)}</td>
        <td class="num">${r.predHold.toFixed(1)}</td>
        <td class="num">${r.matchWin.toFixed(1)}</td>
      </tr>
    `).join("");

    $("wrap").style.display="block";
    const dropped = rows.length % 2 ? 1 : 0;
    $("status").textContent =
      `Loaded ${rows.length} rows â†’ ${Math.floor(rows.length/2)} matchups. ` +
      `Match Win% uses set DP + 50/50 tiebreak + BO3. ` +
      (dropped ? "(Dropped last orphan row.)" : "");

    // copy handlers
    document.querySelectorAll("button[data-name]").forEach(b=>{
      b.onclick=async()=>{
        const name=decodeURIComponent(b.dataset.name);
        try{ await navigator.clipboard.writeText(name); toast(`Copied: ${name}`); }
        catch{ toast("Copy blocked"); }
      };
    });

  }catch(err){
    $("status").textContent = `Error: ${err?.message || err}`;
  }
});
</script>
</body>
</html>
