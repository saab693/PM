<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PM Filter</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#6a00ff">
<link rel="icon" href="PM_icon.png">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#0f0f14;
  color:#eee;
  margin:0;
  padding:20px;
}
h1{font-size:34px;margin:0 0 18px 0;font-weight:800;}
.bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 18px 0;}
label{font-size:18px}
select,input{
  padding:10px 12px;border-radius:10px;border:1px solid #2a2a3a;
  background:#151522;color:#eee;font-size:16px;
}
button{
  background:#6a00ff;color:white;border:none;
  padding:10px 16px;border-radius:10px;font-weight:800;font-size:16px;
}
table{
  width:100%;border-collapse:collapse;margin-top:20px;
  background:#151522;border:1px solid #2a2a3a;border-radius:12px;overflow:hidden;
}
th,td{padding:12px 10px;border-bottom:1px solid #2a2a3a;text-align:left;}
th{font-size:18px}
tr:last-child td{border-bottom:none}

.pill{
  display:inline-flex;align-items:center;justify-content:center;
  width:40px;height:40px;border-radius:12px;
  background:#101020;border:1px solid #2a2a3a;
  color:#a78bfa;font-weight:900;text-decoration:none;
  font-size:20px;
}
.pill:active{transform:scale(0.97)}
.toast{
  position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
  background:#151522;border:1px solid #2a2a3a;padding:10px 14px;border-radius:12px;
  color:#eee;font-weight:700;opacity:0;pointer-events:none;transition:opacity 180ms ease;
}
.toast.show{opacity:1}
</style>
</head>

<body>

<h1>PM Filter</h1>

<div class="bar">
  <input type="file" id="file" accept=".csv">
</div>

<div class="bar">
  <label for="tour">Tour:</label>
  <select id="tour">
    <option value="WTA">WTA</option>
    <option value="ATP">ATP</option>
    <option value="CH">Challenger</option>
  </select>

  <button onclick="runFilter()">Run Filter</button>
</div>

<div id="result"></div>
<div id="toast" class="toast">Copied</div>

<script>
const HOLD_THRESHOLD = { WTA: 66, ATP: 78, CH: 80 };
const COMBINED_THRESHOLD = 100;

let dataset = [];

document.getElementById("file").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    transformHeader: (h) => String(h || "").trim(),
    complete: (res) => dataset = res.data || []
  });
});

function toNumber(v){
  if (v === null || v === undefined) return NaN;
  const n = parseFloat(String(v).replace("%","").trim());
  return Number.isFinite(n) ? n : NaN;
}

function findColumn(row, candidates){
  for (const c of candidates){
    if (row[c] !== undefined) return c;
  }
  return null;
}

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._timer);
  toast._timer = setTimeout(()=>t.classList.remove("show"), 900);
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    // fallback
    try{
      const ta=document.createElement("textarea");
      ta.value=text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      return true;
    }catch(_){
      return false;
    }
  }
}

// ⚡: copy name, then open flashscore.com.
// If your Pixel is set to “Open supported links” for Flashscore, this should open the APP.
// If not, it opens the website (still fine) — but never the Play Store.
async function lightning(player){
  const ok = await copyToClipboard(player);
  toast(ok ? ("Copied: " + player) : "Copy failed");

  setTimeout(() => {
    window.location.href = "https://www.flashscore.com/";
  }, 250);
}

function runFilter(){
  if (!dataset.length){
    document.getElementById("result").innerHTML = "";
    return;
  }

  const tour=document.getElementById("tour").value;
  const first=dataset[0]||{};

  const holdCol=findColumn(first,["SH %","SH%","Hold %","Hold","Service Hold %"]);
  const oppHoldCol=findColumn(first,["OpH %","OpH%","Opponent Hold %","Opp Hold"]);
  const nameCol=findColumn(first,["Player","player","Name","name"]);

  let html = `<table>
    <tr>
      <th>Player</th><th></th><th>Hold</th><th>Break</th><th>Combined</th>
    </tr>`;

  dataset.forEach(r=>{
    const hold = toNumber(holdCol ? r[holdCol] : null);
    const oppHold = toNumber(oppHoldCol ? r[oppHoldCol] : null);
    if(!Number.isFinite(hold) || !Number.isFinite(oppHold)) return;

    const brk = 100 - oppHold;
    const comb = hold + brk;

    if(hold >= HOLD_THRESHOLD[tour] && comb >= COMBINED_THRESHOLD){
      const player = String(nameCol ? (r[nameCol] || "") : "").trim();
      if(!player) return;

      html += `
        <tr>
          <td>${player}</td>
          <td><a class="pill" href="javascript:void(0)" onclick='lightning(${JSON.stringify(player)})'>⚡</a></td>
          <td>${hold.toFixed(2)}</td>
          <td>${brk.toFixed(2)}</td>
          <td>${comb.toFixed(2)}</td>
        </tr>`;
    }
  });

  html += `</table>`;
  document.getElementById("result").innerHTML = html;
}
</script>

</body>
</html>
