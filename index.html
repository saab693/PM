<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PM Filter</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#6a00ff">
<link rel="icon" href="PM_icon.png">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:#0f0f14;
  color:#eee;
  margin:0;
  padding:20px;
}

h1{font-size:34px;margin-bottom:18px}

.bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px}

select,input{
  padding:10px;border-radius:10px;border:1px solid #2a2a3a;
  background:#151522;color:#eee;
}

button{
  background:#6a00ff;color:white;border:none;
  padding:10px 16px;border-radius:10px;font-weight:700;
}

table{
  width:100%;border-collapse:collapse;margin-top:20px;
  background:#151522;border-radius:12px;overflow:hidden;
}

th,td{padding:12px;border-bottom:1px solid #2a2a3a}
th{text-align:left}

a{color:#a78bfa;text-decoration:none;font-weight:bold}
</style>
</head>

<body>

<h1>PM Filter</h1>

<div class="bar">
  <input type="file" id="file" accept=".csv">
</div>

<div class="bar">
  <label>Tour:</label>
  <select id="tour">
    <option value="WTA">WTA</option>
    <option value="ATP">ATP</option>
    <option value="CH">Challenger</option>
  </select>

  <button onclick="runFilter()">Run Filter</button>
</div>

<div id="result"></div>

<script>
// ---------------- SETTINGS ----------------
const HOLD_THRESHOLD = { WTA: 66, ATP: 78, CH: 80 };
const COMBINED_THRESHOLD = 100;

let dataset = [];

// ---------------- CSV LOAD ----------------
document.getElementById('file').addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;

  Papa.parse(file,{
    header:true,
    skipEmptyLines:true,
    transformHeader:h=>h.trim(),
    complete:res=> dataset = res.data
  });
});

// ---------------- HELPERS ----------------
function toNumber(v){
  if(v==null) return NaN;
  return parseFloat(String(v).replace('%','').trim());
}

function findColumn(row, names){
  return names.find(n => row[n] !== undefined);
}

function buildFlashscoreIntent(player){
  return `intent://search/?q=${encodeURIComponent(player)}#Intent;package=eu.livesport.FlashScore_com;scheme=https;end`;
}

// ---------------- MAIN FILTER ----------------
function runFilter(){

  if(!dataset.length){
    document.getElementById('result').innerHTML="";
    return;
  }

  const tour = document.getElementById('tour').value;
  const output = [];

  const firstRow = dataset[0];

  const holdCol = findColumn(firstRow,[
    "SH %","SH%","Hold %","Hold","Service Hold %"
  ]);

  const oppHoldCol = findColumn(firstRow,[
    "OpH %","OpH%","Opponent Hold %","Opp Hold"
  ]);

  const nameCol = findColumn(firstRow,[
    "Player","player","Name","name"
  ]);

  dataset.forEach(row=>{

    const hold = toNumber(row[holdCol]);
    const oppHold = toNumber(row[oppHoldCol]);

    if(!Number.isFinite(hold) || !Number.isFinite(oppHold)) return;

    const breakPct = 100 - oppHold;
    const combined = hold + breakPct;

    if(hold >= HOLD_THRESHOLD[tour] && combined >= COMBINED_THRESHOLD){

      const player = row[nameCol] || "";
      output.push({
        player,
        hold: hold.toFixed(2),
        breakPct: breakPct.toFixed(2),
        combined: combined.toFixed(2),
        intent: buildFlashscoreIntent(player)
      });
    }
  });

  renderTable(output);
}

// ---------------- TABLE RENDER ----------------
function renderTable(rows){

  let html = `
  <table>
    <tr>
      <th>Player</th>
      <th></th>
      <th>Hold</th>
      <th>Break</th>
      <th>Combined</th>
    </tr>`;

  rows.forEach(r=>{
    html += `
    <tr>
      <td>${r.player}</td>
      <td><a href="${r.intent}">ðŸ“±</a></td>
      <td>${r.hold}</td>
      <td>${r.breakPct}</td>
      <td>${r.combined}</td>
    </tr>`;
  });

  html += "</table>";
  document.getElementById('result').innerHTML = html;
}
</script>

</body>
</html>
