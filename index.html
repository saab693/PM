<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>PM Filter</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#6a00ff">
<link rel="icon" href="PM_icon.png">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#090a12;
  --card:rgba(255,255,255,.06);
  --text:#f2f2f7;
  --muted:rgba(242,242,247,.72);
  --line:rgba(255,255,255,.10);
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(900px 500px at 20% -10%, rgba(106,0,255,.25), transparent 55%),
    radial-gradient(900px 500px at 90% 0%, rgba(106,0,255,.18), transparent 60%),
    var(--bg);
  color:var(--text);
  min-height:100vh;
  padding:18px 14px 28px;
}
.wrap{max-width:980px;margin:0 auto}
h1{margin:18px 0 14px;font-size:56px;font-weight:800;line-height:1}

.panel{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
}

.row{display:grid;gap:12px;grid-template-columns:1fr}
@media(min-width:860px){
  .row.grid2{grid-template-columns:1fr 1fr}
}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}

input,select{
  width:100%;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.10);
  color:var(--text);
  border-radius:14px;
  padding:12px;
  font-size:16px;
}

.btn{
  width:100%;
  background:linear-gradient(180deg,#6a00ff,#5300c7);
  border:none;
  color:white;
  font-weight:900;
  padding:14px;
  border-radius:16px;
  font-size:18px;
  cursor:pointer;
}
.btn.secondary{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(242,242,247,.92);
  box-shadow:none;
}

.table-wrap{
  margin-top:14px;
  border-radius:var(--radius);
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  overflow:hidden;
}
.scroller{overflow:auto}
table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
thead th{
  position:sticky;top:0;background:#10101a;border-bottom:1px solid var(--line);
  padding:12px;font-size:14px;white-space:nowrap
}
tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);white-space:nowrap}
.player{font-weight:900;font-size:18px}
.right{text-align:right}

.pill{
  padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);
  cursor:pointer;font-weight:900; display:inline-block;
}

.small{font-size:12px;color:var(--muted);margin-top:6px}

.toast{
  position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
  background:rgba(20,20,28,.92);border:1px solid rgba(255,255,255,.12);
  color:rgba(242,242,247,.95);padding:10px 12px;border-radius:12px;
  box-shadow:0 16px 50px rgba(0,0,0,.6);font-weight:900;
  opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;
  z-index:9999;
}
.toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}
</style>
</head>

<body>
<div class="wrap">
  <h1>PM Filter</h1>

  <div class="panel">
    <div class="row">
      <div>
        <div class="label">CSV file</div>
        <input id="file" type="file" accept=".csv,text/csv">
      </div>

      <div>
        <div class="label">Tour</div>
        <select id="tour">
          <option value="MEN" selected>Men (ATP / Challenger)</option>
          <option value="WOMEN">Women (WTA)</option>
        </select>
        <div class="small" id="tourHint">Default hold threshold: 80%</div>
      </div>

      <div>
        <div class="label">Min hold % (SH%)</div>
        <input id="minHold" type="number" step="0.1" value="80">
        <div class="small">Filter is still based on SH%. Pred Hold (Markov) is shown for info.</div>
      </div>

      <div class="row grid2">
        <div>
          <div class="label">Min odds</div>
          <input id="minOdds" type="number" step="0.01" value="1.15">
        </div>
        <div>
          <div class="label">Max odds</div>
          <input id="maxOdds" type="number" step="0.01" value="1.70">
        </div>
      </div>

      <div class="row grid2">
        <button class="btn" id="run">Run Filter</button>
        <button class="btn secondary" id="export" disabled>Export Results (CSV)</button>
      </div>

      <div class="small" id="status">Ready. Assumes rows are in couplets for Pred Hold (Markov).</div>
    </div>

    <div id="out" class="table-wrap" style="display:none">
      <div class="scroller">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const fileEl = document.getElementById("file");
const tourEl = document.getElementById("tour");
const tourHint = document.getElementById("tourHint");
const minHoldEl = document.getElementById("minHold");
const minOddsEl = document.getElementById("minOdds");
const maxOddsEl = document.getElementById("maxOdds");
const exportBtn = document.getElementById("export");
const statusEl = document.getElementById("status");
const toast = document.getElementById("toast");

let LAST_ROWS = [];

let toastTimer=null;
function showToast(msg){
  toast.textContent=msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove("show"), 900);
}

function num(x){
  const v = parseFloat(String(x??"").replace("%","").replace(",",".").trim());
  return Number.isFinite(v) ? v : NaN;
}
function finite(x){ return Number.isFinite(x); }

function pick(row, names){
  for(const n of names){
    if(row[n] !== undefined) return row[n];
  }
  return undefined;
}
function escapeHtml(s){
  return String(s??"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function updateTourDefaults(){
  if(tourEl.value==="MEN"){
    tourHint.textContent = "Default hold threshold: 80%";
    if(!minHoldEl.dataset.userSet) minHoldEl.value = "80";
  }else{
    tourHint.textContent = "Default hold threshold: 66%";
    if(!minHoldEl.dataset.userSet) minHoldEl.value = "66";
  }
}
tourEl.addEventListener("change", updateTourDefaults);
minHoldEl.addEventListener("input", ()=>{ minHoldEl.dataset.userSet="1"; });
updateTourDefaults();

/* Markov hold from point win prob p */
function holdFromPointP(p){
  if(!(p>0 && p<1)) return NaN;
  const q = 1 - p;
  const first = Math.pow(p,4) * (1 + 4*q + 10*q*q);
  const deuceReach = 20 * Math.pow(p,3) * Math.pow(q,3);
  const pWinFromDeuce = (p*p) / (1 - 2*p*q);
  return first + deuceReach * pWinFromDeuce;
}
const pctToDec = p => p/100;
const decToPct = d => d*100;

/* Serve point p = average(SPW_A, 1 - RPW_B) */
function matchupPointServe(spwA, rpwB){
  return (spwA + (1 - rpwB)) / 2;
}

function extract(row){
  const player = pick(row, ["Player","player","Name","name"]);
  const sh = pick(row, ["SH %","SH%","Hold","Hold%","Hold %"]);
  const odds = pick(row, ["Odds","odds","Price","price","PM Odds","PreMatch Odds","Match Odds","match odds"]);
  const spw = pick(row, ["SPW %","SPW%","SPW"]);
  const rpw = pick(row, ["RPW %","RPW%","RPW"]);

  return {
    player: String(player ?? "").trim(),
    sh: num(sh),
    odds: num(odds),
    spw: num(spw),
    rpw: num(rpw),
    predHold: NaN // filled later from couplets
  };
}

function oddsPass(odds){
  const minO = num(minOddsEl.value);
  const maxO = num(maxOddsEl.value);
  if(!finite(odds)) return true; // allow blanks
  if(finite(minO) && odds < minO) return false;
  if(finite(maxO) && odds > maxO) return false;
  return true;
}

function passes(r){
  const minHold = num(minHoldEl.value);
  if(!r.player) return false;
  if(!finite(r.sh)) return false;
  if(r.sh < minHold) return false;
  if(!oddsPass(r.odds)) return false;
  return true;
}

/* Fill predHold (Markov) using couplets:
   For row i (A) with opponent row i+1 (B):
   pServeA = avg(SPW_A, 1 - RPW_B), then Markov hold.
*/
function computePredHolds(rows){
  for(let i=0;i<rows.length;i+=2){
    const a = rows[i];
    const b = rows[i+1];
    if(!a || !b) continue;

    if(finite(a.spw) && finite(b.rpw)){
      const pA = matchupPointServe(pctToDec(a.spw), pctToDec(b.rpw));
      a.predHold = decToPct(holdFromPointP(pA));
    }
    if(finite(b.spw) && finite(a.rpw)){
      const pB = matchupPointServe(pctToDec(b.spw), pctToDec(a.rpw));
      b.predHold = decToPct(holdFromPointP(pB));
    }
  }
  return rows;
}

function render(rows){
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");

  thead.innerHTML = `
    <tr>
      <th></th>
      <th>Player</th>
      <th class="right">SH%</th>
      <th class="right">Odds</th>
      <th class="right">SPW%</th>
      <th class="right">RPW%</th>
      <th class="right">Pred Hold%</th>
    </tr>
  `;
  tbody.innerHTML = "";

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="pill" data-copy="${encodeURIComponent(r.player)}">⚡</span></td>
      <td><div class="player">${escapeHtml(r.player)}</div></td>
      <td class="right">${finite(r.sh) ? r.sh.toFixed(1) : ""}</td>
      <td class="right">${finite(r.odds) ? r.odds.toFixed(2) : ""}</td>
      <td class="right">${finite(r.spw) ? r.spw.toFixed(1) : ""}</td>
      <td class="right">${finite(r.rpw) ? r.rpw.toFixed(1) : ""}</td>
      <td class="right">${finite(r.predHold) ? r.predHold.toFixed(1) : ""}</td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("[data-copy]").forEach(el=>{
    el.addEventListener("click", async ()=>{
      const name = decodeURIComponent(el.getAttribute("data-copy") || "");
      try{
        await navigator.clipboard.writeText(name);
        showToast("Copied");
      }catch(e){
        showToast("Copy failed");
      }
    });
  });

  document.getElementById("out").style.display = "block";
}

function downloadCSV(rows, filename){
  if(!rows.length){ showToast("Nothing to export"); return; }
  const headers = Object.keys(rows[0]);
  const esc = (v)=>{
    const s = String(v ?? "");
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const lines = [headers.map(esc).join(",")];
  rows.forEach(r=>lines.push(headers.map(h=>esc(r[h])).join(",")));
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function exportRows(rows){
  const tour = tourEl.value==="MEN" ? "MEN" : "WOMEN";
  return rows.map(r=>({
    Tour: tour,
    Player: r.player,
    "SH%": finite(r.sh) ? r.sh.toFixed(1) : "",
    Odds: finite(r.odds) ? r.odds.toFixed(2) : "",
    "SPW%": finite(r.spw) ? r.spw.toFixed(1) : "",
    "RPW%": finite(r.rpw) ? r.rpw.toFixed(1) : "",
    "PredHold%": finite(r.predHold) ? r.predHold.toFixed(1) : ""
  }));
}

document.getElementById("run").onclick = ()=>{
  const f = fileEl.files && fileEl.files[0];
  if(!f){ showToast("Choose a CSV"); return; }

  Papa.parse(f, {
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      // Parse full sheet, compute pred holds on full couplet list, THEN filter
      let all = (res.data || []).map(extract);
      all = computePredHolds(all);

      const filtered = all.filter(passes);

      LAST_ROWS = filtered;
      exportBtn.disabled = filtered.length === 0;

      statusEl.textContent =
        `Filtered ${filtered.length} players (SH ≥ ${minHoldEl.value}; odds ${minOddsEl.value}–${maxOddsEl.value} if odds present). Pred Hold uses SPW/RPW couplets.`;

      render(filtered);
      showToast(filtered.length ? "Done" : "No players");
    },
    error:()=>{
      showToast("Parse failed");
    }
  });
};

exportBtn.addEventListener("click", ()=>{
  if(!LAST_ROWS.length){ showToast("Run filter first"); return; }
  const stamp = new Date().toISOString().slice(0,10).replace(/-/g,"");
  const tour = tourEl.value==="MEN" ? "MEN" : "WOMEN";
  downloadCSV(exportRows(LAST_ROWS), `PM_holdfilter_${tour}_${stamp}.csv`);
});

// keep PWA installable
if ("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
