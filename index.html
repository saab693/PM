<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PM Filter</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#0b0b12;
  --card:#151526;
  --muted:#a7a7c2;
  --text:#f2f2ff;
  --line:rgba(255,255,255,.08);
  --accent:#6a00ff;
  --accent2:#9b4dff;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#1a0033,#0b0b12);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
.wrap{max-width:1000px;margin:auto;padding:30px 20px;}
h1{font-size:48px;margin:0 0 20px;font-weight:800;}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:20px;
  padding:20px;
}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;}
label{font-size:12px;color:var(--muted);}
input,select{
  background:#1c1c30;
  border:1px solid var(--line);
  color:#fff;
  padding:10px;
  border-radius:12px;
  min-width:140px;
}
.btn{
  background:linear-gradient(180deg,var(--accent2),var(--accent));
  border:none;
  color:#fff;
  padding:12px 18px;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
}
.btn:disabled{opacity:.4;cursor:not-allowed}
.pill{
  margin-top:12px;
  padding:8px 12px;
  border-radius:999px;
  background:#1c1c30;
  border:1px solid var(--line);
  color:var(--muted);
  display:inline-block;
  font-size:13px;
}
.tableWrap{
  margin-top:20px;
  overflow:auto;
  display:none;
}
table{width:100%;border-collapse:collapse;min-width:900px;}
th,td{padding:10px;border-bottom:1px solid var(--line);}
th{color:var(--muted);font-size:12px;text-align:left;}
.right{text-align:right;}
.copyBtn{
  background:#222240;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  color:#fff;
  font-size:12px;
}
</style>
</head>

<body>
<div class="wrap">
<h1>PM Filter</h1>

<div class="card">
<div class="row">
<div>
<label>CSV</label><br>
<input type="file" id="file" accept=".csv">
</div>

<div>
<label>Tour</label><br>
<select id="tour">
<option value="WTA">WTA</option>
<option value="ATP">ATP / Challenger</option>
</select>
</div>

<div>
<label>Min Hold%</label><br>
<select id="holdMin"></select>
</div>

<div>
<label>Min Odds</label><br>
<input id="minOdds" value="1.15">
</div>

<div>
<label>Max Odds</label><br>
<input id="maxOdds" value="1.70">
</div>

<button class="btn" id="runBtn">Run Filter</button>
</div>

<div id="status" class="pill">No file loaded.</div>

<div class="tableWrap" id="tableWrap">
<table>
<thead>
<tr>
<th>Copy</th>
<th>Player</th>
<th class="right">Odds</th>
<th class="right">SH%</th>
<th class="right">SPW%</th>
<th class="right">RPW%</th>
<th class="right">Pred Hold%</th>
<th class="right">Match Win%</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>
</div>

<script>

// ---------- Utilities ----------
const num = v => {
  if(v==null) return NaN;
  const x=parseFloat(String(v).replace('%','').replace(',','.'));
  return isFinite(x)?x:NaN;
};
const clamp01 = x => Math.max(0.001,Math.min(0.999,x));

// ---------- Hold from point ----------
function holdFromPoint(p){
  p=clamp01(p);
  const q=1-p;
  const winBeforeDeuce=Math.pow(p,4)*(1+4*q+10*q*q);
  const reachDeuce=20*Math.pow(p,3)*Math.pow(q,3);
  const winFromDeuce=(p*p)/(1-2*p*q);
  return winBeforeDeuce+reachDeuce*winFromDeuce;
}

// ---------- Stable Tiebreak DP ----------
function tbWinProb(pAserve,pBserve,firstServer){
  const pAonA=clamp01(pAserve);
  const pAonB=clamp01(1-pBserve);

  const memo=new Map();
  const key=(a,b,s,r,f)=>`${a}|${b}|${s}|${r}|${f}`;

  function solve(a,b,server,rem,firstDone){
    if(a>=7 && a-b>=2) return 1;
    if(b>=7 && b-a>=2) return 0;

    const k=key(a,b,server,rem,firstDone);
    if(memo.has(k)) return memo.get(k);

    const pA=(server===0)?pAonA:pAonB;

    let nextServer=server,nextRem=rem,nextFirst=firstDone;

    if(!firstDone){
      nextFirst=true;
      nextServer=1-server;
      nextRem=2;
    }else{
      nextRem=rem-1;
      if(nextRem===0){
        nextServer=1-server;
        nextRem=2;
      }
    }

    const res=pA*solve(a+1,b,nextServer,nextRem,nextFirst)
              +(1-pA)*solve(a,b+1,nextServer,nextRem,nextFirst);

    memo.set(k,res);
    return res;
  }

  return solve(0,0,firstServer,1,false);
}

// ---------- Set DP ----------
function setWinProb(hA,hB,pAserve,pBserve,startServer){
  const memo=new Map();
  const key=(gA,gB,s)=>`${gA}|${gB}|${s}`;

  function terminal(gA,gB){
    if(gA>=6 && gA-gB>=2) return 1;
    if(gB>=6 && gB-gA>=2) return 0;
    if(gA===7) return 1;
    if(gB===7) return 0;
    return null;
  }

  function solve(gA,gB,server){
    const t=terminal(gA,gB);
    if(t!==null) return t;

    if(gA===6 && gB===6)
      return tbWinProb(pAserve,pBserve,server);

    const k=key(gA,gB,server);
    if(memo.has(k)) return memo.get(k);

    const pAwin=(server===0)?hA:(1-hB);

    const res=pAwin*solve(gA+1,gB,1-server)
             +(1-pAwin)*solve(gA,gB+1,1-server);

    memo.set(k,res);
    return res;
  }

  return solve(0,0,startServer);
}

const matchWinFromSet=p=>p*p*(3-2*p);

// ---------- UI Setup ----------
const holdMinEl=document.getElementById('holdMin');
for(let i=50;i<=90;i++){
  const o=document.createElement('option');
  o.value=i;o.textContent=i;
  holdMinEl.appendChild(o);
}
holdMinEl.value="66";

document.getElementById('tour').addEventListener('change',e=>{
  holdMinEl.value=(e.target.value==="WTA")?"66":"80";
});

// ---------- Main ----------
const runBtn=document.getElementById('runBtn');
const statusEl=document.getElementById('status');
const tbody=document.getElementById('tbody');
const tableWrap=document.getElementById('tableWrap');

runBtn.addEventListener('click',async()=>{
  const file=document.getElementById('file').files[0];
  if(!file){statusEl.textContent="Choose CSV";return;}

  runBtn.disabled=true;
  statusEl.textContent="Reading CSV...";
  tbody.innerHTML="";
  tableWrap.style.display="none";

  const text=await file.text();
  const parsed=Papa.parse(text.replace(/^\uFEFF/,''),{
    header:true,
    skipEmptyLines:true
  });

  const rows=parsed.data;
  if(!rows.length){statusEl.textContent="No rows found";runBtn.disabled=false;return;}

  const headers=Object.keys(rows[0]).map(h=>h.toLowerCase());
  const find=h=>Object.keys(rows[0]).find(k=>k.toLowerCase().includes(h));

  const kPlayer=find("player")||find("name");
  const kSH=find("hold");
  const kSPW=find("spw");
  const kRPW=find("rpw");
  const kOdds=find("odds");

  if(!kPlayer||!kSH){
    statusEl.textContent="Missing Player or Hold column";
    runBtn.disabled=false;
    return;
  }

  const holdMin=num(holdMinEl.value);
  const minOdds=num(document.getElementById('minOdds').value);
  const maxOdds=num(document.getElementById('maxOdds').value);

  const out=[];

  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    const player=r[kPlayer];
    const sh=num(r[kSH]);
    const odds=kOdds?num(r[kOdds]):NaN;

    if(!isFinite(sh)||sh<holdMin) continue;
    if(isFinite(odds)&&(odds<minOdds||odds>maxOdds)) continue;

    let spw=kSPW?num(r[kSPW]):NaN;
    let rpw=kRPW?num(r[kRPW]):NaN;

    const opp=rows[i+1]||{};
    const oppSpw=kSPW?num(opp[kSPW]):NaN;
    const oppRpw=kRPW?num(opp[kRPW]):NaN;

    let predHold=NaN,matchWin=NaN;

    if(isFinite(spw)&&isFinite(oppRpw)){
      const pAserve=(spw/100+(1-oppRpw/100))/2;
      predHold=holdFromPoint(pAserve)*100;

      if(isFinite(oppSpw)&&isFinite(rpw)){
        const pBserve=(oppSpw/100+(1-rpw/100))/2;
        const hA=holdFromPoint(pAserve);
        const hB=holdFromPoint(pBserve);

        const pSet=0.5*setWinProb(hA,hB,pAserve,pBserve,0)
                  +0.5*setWinProb(hA,hB,pAserve,pBserve,1);

        matchWin=matchWinFromSet(pSet)*100;
      }
    }

    out.push({player,odds,sh,spw,rpw,predHold,matchWin});
  }

  if(!out.length){
    statusEl.textContent="No matches found";
    runBtn.disabled=false;
    return;
  }

  const fmt=(x,d=1)=>isFinite(x)?x.toFixed(d):"";

  for(const r of out){
    const tr=document.createElement('tr');

    const tdCopy=document.createElement('td');
    const btn=document.createElement('button');
    btn.className="copyBtn";
    btn.textContent="âš¡ Copy";
    btn.onclick=()=>navigator.clipboard.writeText(r.player);
    tdCopy.appendChild(btn);

    tr.innerHTML+=`
      <td style="display:none"></td>
      <td>${r.player}</td>
      <td class="right">${fmt(r.odds,2)}</td>
      <td class="right">${fmt(r.sh)}</td>
      <td class="right">${fmt(r.spw)}</td>
      <td class="right">${fmt(r.rpw)}</td>
      <td class="right">${fmt(r.predHold)}</td>
      <td class="right">${fmt(r.matchWin)}</td>
    `;
    tr.replaceChild(tdCopy,tr.firstChild);
    tbody.appendChild(tr);
  }

  tableWrap.style.display="block";
  statusEl.textContent=`Filtered ${out.length} players.`;
  runBtn.disabled=false;
});
</script>
</body>
</html>
