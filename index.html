<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PM Filter</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#6a00ff">
  <link rel="icon" href="PM_icon.png">

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0f0f14;
      --card:#141625;
      --muted:#9aa0b2;
      --text:#eef0f7;
      --line:rgba(255,255,255,.08);
      --accent:#6a00ff;
      --accent2:#8a3dff;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(900px 500px at 30% 0%, rgba(106,0,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(138,61,255,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:860px;margin:0 auto;padding:22px 18px 40px}
    h1{margin:8px 0 18px;font-size:44px;letter-spacing:.2px}
    .panel{
      background:linear-gradient(180deg, rgba(20,22,37,.85), rgba(20,22,37,.65));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 16px 40px rgba(0,0,0,.35);
    }
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-end}
    .row + .row{margin-top:14px}
    .hint{font-size:13px;color:var(--muted)}
    input[type="file"]{color:var(--muted)}
    select,input[type="number"]{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
      min-width:140px;
    }
    .btn{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border:0;
      color:white;
      font-weight:700;
      padding:12px 18px;
      border-radius:14px;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 10px 20px rgba(106,0,255,.25);
    }
    .btn:active{transform:translateY(1px)}
    .error{color:#ff7b7b;font-size:14px;margin-top:12px;white-space:pre-wrap}

    /* horizontal scroll on mobile */
    .tableWrap{
      margin-top:16px;
      border-radius:16px;
      border:1px solid var(--line);
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      background:rgba(10,10,16,.45);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:620px;
    }
    thead th{
      text-align:left;
      font-size:14px;
      color:#cfd3e6;
      padding:12px 14px;
      background:rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      font-size:16px;
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr:last-child td{border-bottom:0}

    .playerCell{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:240px;
    }
    .pname{
      font-weight:650;
      white-space:normal;
      line-height:1.15;
      max-width:170px;
    }

    .fsBtn{
      width:38px;height:38px;
      display:inline-flex;
      align-items:center;justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      cursor:pointer;
      font-size:18px;
      flex:0 0 auto;
      -webkit-tap-highlight-color:transparent;
    }
    .fsBtn:active{transform:translateY(1px)}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }
    .toast.show{opacity:1}

    .scrollHint{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      display:none;
      user-select:none;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>PM Filter</h1>

    <div class="panel">
      <div class="row">
        <div>
          <div class="hint">CSV file</div>
          <input type="file" id="file" accept=".csv" />
        </div>
      </div>

      <div class="row">
        <div>
          <div class="hint">Tour</div>
          <select id="tour">
            <option value="WTA">WTA</option>
            <option value="ATP">ATP</option>
            <option value="CH">CH</option>
          </select>
        </div>

        <div>
          <div class="hint">Max odds</div>
          <input type="number" id="maxOdds" step="0.01" min="1.01" value="1.70" />
        </div>

        <button class="btn" id="runBtn">Run Filter</button>
      </div>

      <div id="err" class="error" style="display:none;"></div>

      <div id="result" class="tableWrap" style="display:none;">
        <table>
          <thead>
            <tr>
              <th style="width:44%;">Player</th>
              <th>Odds</th>
              <th>Hold</th>
              <th>Break</th>
              <th>Combined</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="scrollHint" class="scrollHint">Tip: swipe the table left/right to see all columns.</div>
    </div>
  </div>

  <div id="toast" class="toast">Copied</div>

<script>
  // Thresholds
  const HOLD_THRESH = { WTA: 66, ATP: 78, CH: 80 };
  const COMBINED_MIN = 100;

  const $ = (id) => document.getElementById(id);

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  function num(x){
    if (x === null || x === undefined) return NaN;
    const s = String(x).trim().replace("%","");
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : NaN;
  }

  function pick(obj, keys){
    for (const k of keys){
      if (k in obj) return obj[k];
      const found = Object.keys(obj).find(h => h.trim().toLowerCase() === k.toLowerCase());
      if (found) return obj[found];
    }
    return undefined;
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast("Copied name");
      return true;
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("Copied name");
        return true;
      }catch(err){
        document.body.removeChild(ta);
        showToast("Copy failed");
        return false;
      }
    }
  }

  function flashscoreSearchUrl(playerName){
    const q = encodeURIComponent(playerName);
    return `https://www.flashscore.com/search/?q=${q}`;
  }

  // Key fix: try to open the Flashscore APP via Android Intent,
  // otherwise fall back to normal browser. This avoids Flashscore blocking WebViews.
  function openFlashscore(playerName){
    const url = flashscoreSearchUrl(playerName);

    // Flashscore Android package (from your Play Store link)
    const pkg = "eu.livesport.FlashScore_com";

    // Intent with browser fallback (NOT Play Store)
    const intentUrl =
      `intent://www.flashscore.com/search/?q=${encodeURIComponent(playerName)}` +
      `#Intent;scheme=https;package=${pkg};` +
      `S.browser_fallback_url=${encodeURIComponent(url)};end`;

    // Try intent first (should open app if link handling is enabled)
    try{
      window.location.href = intentUrl;
    }catch(e){
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // If the intent doesn’t resolve, the fallback should open.
    // (We still keep a secondary fallback just in case.)
    setTimeout(() => {
      // If user is still on our page, open browser as a backup
      // (Some devices ignore the fallback_url parameter)
      try{
        window.open(url, "_blank", "noopener,noreferrer");
      }catch(_){}
    }, 600);
  }

  function clearOutput(){
    $("tbody").innerHTML = "";
    $("result").style.display = "none";
    $("err").style.display = "none";
    $("err").textContent = "";
    $("scrollHint").style.display = "none";
  }

  function showError(msg){
    $("err").textContent = msg;
    $("err").style.display = "block";
    $("result").style.display = "none";
    $("scrollHint").style.display = "none";
  }

  function updateScrollHint(){
    const wrap = $("result");
    const hint = $("scrollHint");
    if (wrap.style.display === "none") { hint.style.display = "none"; return; }
    hint.style.display = (wrap.scrollWidth > wrap.clientWidth + 2) ? "block" : "none";
  }

  $("runBtn").addEventListener("click", () => {
    clearOutput();

    const f = $("file").files?.[0];
    if (!f) return showError("Choose a CSV file first.");

    const tour = $("tour").value;
    const holdMin = HOLD_THRESH[tour];
    const maxOdds = num($("maxOdds").value);

    if (!Number.isFinite(maxOdds) || maxOdds <= 1) {
      return showError("Max odds must be a number > 1.00 (e.g. 1.70).");
    }

    Papa.parse(f, {
      header: true,
      skipEmptyLines: true,
      complete: (res) => {
        try{
          const rows = res.data || [];
          if (!rows.length) return showError("No rows found in CSV.");

          const out = [];

          for (const r0 of rows){
            const player = String(pick(r0, ["Player","player","Name","name"]) ?? "").trim();
            if (!player) continue;

            const odds = num(pick(r0, ["Odds","odds","Price","price"]));
            if (!Number.isFinite(odds)) continue;
            if (odds > maxOdds) continue;

            const hold = num(pick(r0, ["SH %","SH%","Hold","Hold %","Hold%","Service Hold","Service Hold %"]));
            const opHold = num(pick(r0, ["OpH %","OpH%","Opponent hold","Opponent Hold","Opponent Hold %","Opp Hold","OppHold","OppHold %"]));
            if (!Number.isFinite(hold) || !Number.isFinite(opHold)) continue;

            const brk = 100 - opHold;
            const combined = hold + brk;

            if (hold >= holdMin && combined >= COMBINED_MIN){
              out.push({ player, odds, hold, brk, combined });
            }
          }

          out.sort((a,b)=> (b.combined - a.combined) || (b.hold - a.hold));

          const tb = $("tbody");
          tb.innerHTML = "";

          for (const r of out){
            const tr = document.createElement("tr");

            const tdP = document.createElement("td");
            const wrap = document.createElement("div");
            wrap.className = "playerCell";

            const name = document.createElement("div");
            name.className = "pname";
            name.textContent = r.player;

            const btn = document.createElement("button");
            btn.className = "fsBtn";
            btn.type = "button";
            btn.title = "Open Flashscore (copies name)";
            btn.textContent = "⚡";
            btn.addEventListener("click", async () => {
              await copyText(r.player);
              openFlashscore(r.player);
            });

            wrap.appendChild(name);
            wrap.appendChild(btn);
            tdP.appendChild(wrap);

            const tdOdds = document.createElement("td");
            tdOdds.textContent = r.odds.toFixed(2);

            const tdH = document.createElement("td");
            tdH.textContent = r.hold.toFixed(2);

            const tdB = document.createElement("td");
            tdB.textContent = r.brk.toFixed(2);

            const tdC = document.createElement("td");
            tdC.textContent = r.combined.toFixed(2);

            tr.appendChild(tdP);
            tr.appendChild(tdOdds);
            tr.appendChild(tdH);
            tr.appendChild(tdB);
            tr.appendChild(tdC);
            tb.appendChild(tr);
          }

          $("result").style.display = "block";
          updateScrollHint();
          setTimeout(updateScrollHint, 50);
        }catch(e){
          showError("Error processing CSV. Check your column headers.\n\n" + (e?.message || e));
        }
      },
      error: (err) => showError("Could not parse CSV.\n\n" + (err?.message || err))
    });
  });

  window.addEventListener("resize", updateScrollHint);
</script>
</body>
</html>
