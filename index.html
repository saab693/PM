<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PM Filter</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#6a00ff">
<link rel="icon" href="PM_icon.png">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:#0f0f14;
    color:#eee;
    margin:0;
    padding:20px;
  }
  h1{font-size:34px;margin:0 0 18px 0;font-weight:800;}
  .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 18px 0;}
  label{font-size:18px}
  select,input{
    padding:10px 12px;border-radius:10px;border:1px solid #2a2a3a;
    background:#151522;color:#eee;font-size:16px;
  }
  button{
    background:#6a00ff;color:white;border:none;
    padding:10px 16px;border-radius:10px;font-weight:800;font-size:16px;
  }
  table{
    width:100%;border-collapse:collapse;margin-top:20px;
    background:#151522;border:1px solid #2a2a3a;border-radius:12px;overflow:hidden;
  }
  th,td{padding:12px 10px;border-bottom:1px solid #2a2a3a;text-align:left;}
  th{font-size:18px}
  tr:last-child td{border-bottom:none}
  .pill{
    display:inline-flex;align-items:center;justify-content:center;
    width:34px;height:34px;border-radius:10px;
    background:#101020;border:1px solid #2a2a3a;
    color:#a78bfa;font-weight:900;text-decoration:none;
  }
</style>
</head>

<body>

<h1>PM Filter</h1>

<div class="bar">
  <input type="file" id="file" accept=".csv">
</div>

<div class="bar">
  <label for="tour">Tour:</label>
  <select id="tour">
    <option value="WTA">WTA</option>
    <option value="ATP">ATP</option>
    <option value="CH">Challenger</option>
  </select>

  <button onclick="runFilter()">Run Filter</button>
</div>

<div id="result"></div>

<script>
  // Thresholds
  const HOLD_THRESHOLD = { WTA: 66, ATP: 78, CH: 80 };
  const COMBINED_THRESHOLD = 100;

  // Flashscore Android package (Play Store)
  const FLASHSCORE_PKG = "eu.livesport.FlashScore_com";

  let dataset = [];

  // Load CSV
  document.getElementById("file").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      transformHeader: (h) => String(h || "").trim(),
      complete: (res) => { dataset = res.data || []; }
    });
  });

  function toNumber(v){
    if (v === null || v === undefined) return NaN;
    const n = parseFloat(String(v).replace("%", "").trim());
    return Number.isFinite(n) ? n : NaN;
  }

  function findColumn(row, candidates){
    for (const c of candidates){
      if (row[c] !== undefined) return c;
    }
    return null;
  }

  // Attempt to open Flashscore APP to the search page.
  // If the app doesn't catch it, fallback to the web URL.
  function openFlashscore(player){
    const q = encodeURIComponent(player);

    // Real Flashscore search URL (app can claim this via App Links)
    const webUrl = `https://www.flashscore.com/search/?query=${q}`;

    // Intent pointing to a REAL Flashscore URL (not a fake "search" host)
    const intentUrl =
      `intent://www.flashscore.com/search/?query=${q}` +
      `#Intent;scheme=https;package=${FLASHSCORE_PKG};end`;

    // Try app first
    window.location.href = intentUrl;

    // Fallback to web after a short delay
    setTimeout(() => {
      window.location.href = webUrl;
    }, 600);
  }

  function runFilter(){
    if (!dataset.length){
      document.getElementById("result").innerHTML = "";
      return;
    }

    const tour = document.getElementById("tour").value;
    const firstRow = dataset[0] || {};

    const holdCol = findColumn(firstRow, ["SH %","SH%","Hold %","Hold","Service Hold %"]);
    const oppHoldCol = findColumn(firstRow, ["OpH %","OpH%","Opponent Hold %","Opp Hold"]);
    const nameCol = findColumn(firstRow, ["Player","player","Name","name"]);

    const out = [];

    dataset.forEach(row => {
      const hold = toNumber(holdCol ? row[holdCol] : null);
      const oppHold = toNumber(oppHoldCol ? row[oppHoldCol] : null);
      if (!Number.isFinite(hold) || !Number.isFinite(oppHold)) return;

      const breakPct = 100 - oppHold;
      const combined = hold + breakPct;

      if (hold >= HOLD_THRESHOLD[tour] && combined >= COMBINED_THRESHOLD){
        out.push({
          player: (nameCol ? (row[nameCol] || "") : ""),
          hold: hold.toFixed(2),
          brk: breakPct.toFixed(2),
          comb: combined.toFixed(2)
        });
      }
    });

    renderTable(out);
  }

  function renderTable(rows){
    let html = `
      <table>
        <tr>
          <th>Player</th>
          <th></th>
          <th>Hold</th>
          <th>Break</th>
          <th>Combined</th>
        </tr>
    `;

    rows.forEach(r => {
      const safeName = r.player.replace(/"/g, "&quot;");
      html += `
        <tr>
          <td>${safeName}</td>
          <td>
            <a class="pill" href="javascript:void(0)" onclick="openFlashscore('${safeName}')">ðŸ“±</a>
          </td>
          <td>${r.hold}</td>
          <td>${r.brk}</td>
          <td>${r.comb}</td>
        </tr>
      `;
    });

    html += `</table>`;
    document.getElementById("result").innerHTML = html;
  }
</script>

</body>
</html>
