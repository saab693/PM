<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>PM Filter</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#6a00ff">
<link rel="icon" href="PM_icon.png">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#090a12;
  --card:rgba(255,255,255,.06);
  --text:#f2f2f7;
  --muted:rgba(242,242,247,.72);
  --line:rgba(255,255,255,.10);
  --shadow:0 18px 60px rgba(0,0,0,.55);
  --radius:18px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(900px 500px at 20% -10%, rgba(106,0,255,.25), transparent 55%),
    radial-gradient(900px 500px at 90% 0%, rgba(106,0,255,.18), transparent 60%),
    var(--bg);
  color:var(--text);
  min-height:100vh;
  padding:18px 14px 28px;
}
.wrap{max-width:980px;margin:0 auto}
h1{margin:18px 0 14px;font-size:56px;font-weight:800}

.panel,.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
}
.card{margin:0 0 14px;}

.row{display:grid;gap:12px;grid-template-columns:1fr}
@media(min-width:860px){
  .row.grid2{grid-template-columns:1fr 1fr}
}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}

input,select{
  width:100%;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.10);
  color:var(--text);
  border-radius:14px;
  padding:12px;
  font-size:16px;
}

.btn{
  width:100%;
  background:linear-gradient(180deg,#6a00ff,#5300c7);
  border:none;
  color:white;
  font-weight:950;
  padding:14px;
  border-radius:16px;
  font-size:18px;
  cursor:pointer;
}
.btn.secondary{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(242,242,247,.92);
  box-shadow:none;
}
.btn.danger{
  background:rgba(255,60,60,.14);
  border:1px solid rgba(255,60,60,.25);
  color:rgba(242,242,247,.92);
}

.small{font-size:12px;color:var(--muted);margin-top:6px}
.right{text-align:right}

.table-wrap{
  margin-top:14px;
  border-radius:var(--radius);
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  overflow:hidden;
}
.scroller{overflow:auto}
table{border-collapse:separate;border-spacing:0;width:max-content;min-width:100%}
thead th{
  position:sticky;top:0;background:#10101a;border-bottom:1px solid var(--line);
  padding:12px;font-size:14px;white-space:nowrap
}
tbody td{padding:12px;border-bottom:1px solid rgba(255,255,255,.06);white-space:nowrap}
.player{font-weight:950;font-size:18px}
.muted{color:var(--muted);font-size:12px;margin-top:2px}

.match-row{background:rgba(255,255,255,.03); font-weight:950}
.match-title{display:flex;align-items:center;justify-content:space-between;gap:10px}
.match-actions{display:flex;gap:8px;flex-wrap:wrap}

.pill{
  padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);
  cursor:pointer;font-weight:950
}
.pill.small{padding:7px 10px;font-size:13px}
.pill.add{
  background:rgba(106,0,255,.18);
  border:1px solid rgba(106,0,255,.25);
}
.pill.remove{
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
}

.card-head{
  display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;
}
.card h2{
  margin:0;
  font-size:14px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:rgba(242,242,247,.85);
}
.list{display:grid;gap:10px}
.item{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  border-radius:16px;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}
.item .title{font-weight:950;font-size:16px}
.item .meta{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.3}
.item .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:rgba(20,20,28,.92);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(242,242,247,.95);
  padding:10px 12px; border-radius:12px;
  box-shadow:0 16px 50px rgba(0,0,0,.6);
  font-weight:950;
  opacity:0; pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  z-index:9999;
}
.toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}

#debugBox{
  margin:0 0 14px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.05);
  padding:10px 12px;
  font-size:12px;
  color:rgba(242,242,247,.88);
  white-space:pre-wrap;
  display:none;
}
#debugBox.bad{
  display:block;
  border-color:rgba(255,80,80,.35);
  background:rgba(255,80,80,.12);
}
#debugBox.good{
  display:block;
}
</style>
</head>

<body>
<div class="wrap">
  <h1>PM Filter</h1>

  <!-- In-app debug -->
  <div id="debugBox" class="good"></div>

  <!-- Today List -->
  <div class="card">
    <div class="card-head">
      <h2>Today’s List</h2>
      <button class="btn secondary" id="toggleToday" style="width:auto;padding:10px 12px;border-radius:12px;font-size:14px;">Hide</button>
    </div>
    <div id="todayBody">
      <div class="row grid2" style="margin-bottom:10px;">
        <button class="btn secondary" id="exportToday">Export Today (CSV)</button>
        <button class="btn danger" id="clearToday">Clear Today</button>
      </div>
      <div class="small" id="todayHint">Nothing added yet.</div>
      <div class="list" id="todayList"></div>
    </div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <div class="label">CSV file</div>
        <input id="file" type="file" accept=".csv,text/csv">
      </div>

      <div>
        <div class="label">Tour</div>
        <select id="tour">
          <option value="PRO">ATP / Challenger</option>
          <option value="WTA">WTA</option>
        </select>
      </div>

      <div>
        <div class="label">Predicted hold ≥ (SPW/RPW matchup)</div>
        <!-- Pre-populated so it works even if JS crashes -->
        <select id="holdMin">
          <option value="66">66%</option>
          <option value="67">67%</option>
          <option value="68">68%</option>
          <option value="69">69%</option>
          <option value="70">70%</option>
          <option value="71">71%</option>
          <option value="72">72%</option>
          <option value="73">73%</option>
          <option value="74">74%</option>
          <option value="75">75%</option>
          <option value="78" selected>78%</option>
          <option value="79">79%</option>
          <option value="80">80%</option>
          <option value="81">81%</option>
          <option value="82">82%</option>
          <option value="83">83%</option>
          <option value="84">84%</option>
          <option value="85">85%</option>
        </select>
        <div class="small" id="holdHint">If this dropdown won’t open, JS has crashed (see debug box).</div>
      </div>

      <div>
        <div class="label">Pred Combined ≥</div>
        <input id="minCombined" type="number" step="0.1" value="100">
      </div>

      <div class="row grid2">
        <button class="btn" id="run">Run Filter</button>
        <button class="btn secondary" id="export">Export Results (CSV)</button>
      </div>

      <div class="small">
        Rows are read in couplets (1–2, 3–4, …). Odds ignored. If either player passes thresholds, both are shown.
      </div>
    </div>

    <div id="out" class="table-wrap" style="display:none">
      <div class="scroller">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ---------- debug + error capture ---------- */
const debugBox = document.getElementById("debugBox");
function dbg(msg, bad=false){
  debugBox.className = bad ? "bad" : "good";
  debugBox.style.display = "block";
  debugBox.textContent += (debugBox.textContent ? "\n" : "") + msg;
}
window.addEventListener("error", (e)=>{
  dbg("JS ERROR: " + (e.message || "unknown") + (e.filename ? ("\n" + e.filename + ":" + e.lineno) : ""), true);
});
window.addEventListener("unhandledrejection", (e)=>{
  dbg("PROMISE ERROR: " + (e.reason?.message || String(e.reason || "unknown")), true);
});

dbg("JS loaded.");

/* ---------- app ---------- */
const HOLD_PRESETS = {
  PRO: { values:[75,76,77,78,79,80,81,82,83,84,85], def:78, label:"ATP/Challenger preset" },
  WTA: { values:[63,64,65,66,67,68,69,70,71,72,73,74,75], def:66, label:"WTA preset" }
};
const LS_KEY = "pm_today_list_v1";

const fileEl=document.getElementById("file");
const tourEl=document.getElementById("tour");
const holdMinEl=document.getElementById("holdMin");
const holdHintEl=document.getElementById("holdHint");
const minCombinedEl=document.getElementById("minCombined");
const runBtn=document.getElementById("run");
const exportBtn=document.getElementById("export");

const exportTodayBtn=document.getElementById("exportToday");
const clearTodayBtn=document.getElementById("clearToday");
const todayHintEl=document.getElementById("todayHint");
const todayListEl=document.getElementById("todayList");
const toggleTodayBtn=document.getElementById("toggleToday");
const todayBody=document.getElementById("todayBody");
const toast=document.getElementById("toast");

let LAST_RENDERED_MATCHES=[];
let TODAY=loadToday();

let toastTimer=null;
function showToast(msg){
  toast.textContent=msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove("show"), 1100);
}

function rebuildHoldDropdown(){
  const preset=HOLD_PRESETS[tourEl.value];
  holdMinEl.innerHTML="";
  preset.values.forEach(v=>{
    const opt=document.createElement("option");
    opt.value=String(v);
    opt.textContent=v+"%";
    holdMinEl.appendChild(opt);
  });
  holdMinEl.value=String(preset.def);
  holdHintEl.textContent=preset.label;
  dbg("Hold dropdown built for: " + tourEl.value);
}
tourEl.addEventListener("change", rebuildHoldDropdown);
rebuildHoldDropdown();

fileEl.addEventListener("change", ()=>{
  dbg("File selected: " + (fileEl.files?.[0]?.name || "none"));
});

function num(x){ return parseFloat(String(x??"").replace("%","").replace(",",".").trim()); }
const pctToDec = p => p/100;
const decToPct = d => d*100;

function holdFromPointP(p){
  if(!(p>0 && p<1)) return NaN;
  const q=1-p;
  const first = Math.pow(p,4) * (1 + 4*q + 10*q*q);
  const deuceReach = 20 * Math.pow(p,3) * Math.pow(q,3);
  const pWinFromDeuce = (p*p) / (1 - 2*p*q);
  return first + deuceReach * pWinFromDeuce;
}
function matchupPointServe(spwA_dec, rpwB_dec){
  return (spwA_dec + (1 - rpwB_dec)) / 2;
}
function pick(row,names){
  for(const n of names){ if(row[n]!==undefined) return row[n]; }
  return undefined;
}
function extract(row){
  const player = pick(row,["Player","player","Name","name"]);
  const spw = pick(row,["SPW %","SPW%","SPW"]);
  const rpw = pick(row,["RPW %","RPW%","RPW"]);
  const sh  = pick(row,["SH %","SH%","Hold","Hold%","Hold %"]);
  const oph = pick(row,["OpH %","OpH%","Opponent Hold","Opponent Hold %","Opp Hold %"]);
  return { player:String(player??"").trim(), spw:num(spw), rpw:num(rpw), sh:num(sh), oph:num(oph) };
}
function computeFallback(x, opp){
  const hold = Number.isFinite(x.sh) ? x.sh : NaN;
  let oppHold = NaN;
  if(opp && Number.isFinite(opp.sh)) oppHold = opp.sh;
  else if(Number.isFinite(x.oph)) oppHold = x.oph;
  const brk = Number.isFinite(oppHold) ? 100-oppHold : NaN;
  const comb = (Number.isFinite(hold) && Number.isFinite(brk)) ? hold+brk : NaN;
  return { ...x, opponent: opp ? opp.player : "", predHold: hold, predBreak: brk, predCombined: comb };
}
function computeMatchup(a,b){
  const usable = Number.isFinite(a.spw)&&Number.isFinite(a.rpw)&&Number.isFinite(b.spw)&&Number.isFinite(b.rpw);
  if(usable){
    const pServeA = matchupPointServe(pctToDec(a.spw), pctToDec(b.rpw));
    const pServeB = matchupPointServe(pctToDec(b.spw), pctToDec(a.rpw));
    const holdA = decToPct(holdFromPointP(pServeA));
    const holdB = decToPct(holdFromPointP(pServeB));
    return {
      a:{...a, opponent:b.player, predHold:holdA, predBreak:100-holdB, predCombined:holdA+(100-holdB)},
      b:{...b, opponent:a.player, predHold:holdB, predBreak:100-holdA, predCombined:holdB+(100-holdA)}
    };
  }
  return { a:computeFallback(a,b), b:computeFallback(b,a) };
}
function buildMatches(data){
  const rows = (data||[]).map(extract);
  const matches=[];
  for(let i=0;i<rows.length;i+=2){
    const a=rows[i], b=rows[i+1];
    if(!a || !a.player) continue;
    if(!b || !b.player){ matches.push({a:computeFallback(a,null), b:null}); continue; }
    matches.push(computeMatchup(a,b));
  }
  return matches;
}
function matchPasses(m){
  const holdMin=num(holdMinEl.value);
  const minComb=num(minCombinedEl.value);
  const pass=(s)=> s && Number.isFinite(s.predHold) && Number.isFinite(s.predCombined) && s.predHold>=holdMin && s.predCombined>=minComb;
  return pass(m.a) || pass(m.b);
}

function escapeHtml(s){
  return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
async function copyText(text){
  try{ await navigator.clipboard.writeText(text); showToast("Copied"); }
  catch(e){ showToast("Copy failed"); }
}
function todayKeyForMatch(m){
  const p1=m.a?.player||"", p2=m.b?.player||"";
  return (p1&&p2 ? [p1,p2].sort().join("___") : p1).toLowerCase();
}
function matchTitle(m){ return m.b ? `${m.a.player} vs ${m.b.player}` : `${m.a.player}`; }

/* Today list */
function loadToday(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    const arr=raw?JSON.parse(raw):[];
    return Array.isArray(arr)?arr:[];
  }catch(e){ return []; }
}
function saveToday(){ localStorage.setItem(LS_KEY, JSON.stringify(TODAY)); }
function simplifySide(s){
  return {
    player:s.player, opponent:s.opponent||"",
    predHold:Number.isFinite(s.predHold)?+s.predHold.toFixed(1):null,
    predBreak:Number.isFinite(s.predBreak)?+s.predBreak.toFixed(1):null,
    predCombined:Number.isFinite(s.predCombined)?+s.predCombined.toFixed(1):null,
    spw:Number.isFinite(s.spw)?+s.spw.toFixed(1):null,
    rpw:Number.isFinite(s.rpw)?+s.rpw.toFixed(1):null
  };
}
function addToToday(m){
  const key=todayKeyForMatch(m);
  if(TODAY.some(x=>x.key===key)){ showToast("Already added"); return; }
  TODAY.unshift({
    key, tour:tourEl.value, addedAt:new Date().toISOString(),
    title:matchTitle(m),
    a:simplifySide(m.a),
    b:m.b?simplifySide(m.b):null
  });
  saveToday();
  renderToday();
  showToast("Added");
}
function removeFromToday(key){
  TODAY=TODAY.filter(x=>x.key!==key);
  saveToday();
  renderToday();
  showToast("Removed");
}
function clearToday(){
  TODAY=[]; saveToday(); renderToday(); showToast("Cleared");
}
function fmt(v){ return (v===null||v===undefined)?"—":String(v); }
function renderToday(){
  todayListEl.innerHTML="";
  if(!TODAY.length){
    todayHintEl.textContent="Nothing added yet.";
    return;
  }
  todayHintEl.textContent=`${TODAY.length} match${TODAY.length===1?"":"es"} saved.`;
  TODAY.forEach(item=>{
    const div=document.createElement("div");
    div.className="item";
    const left=document.createElement("div");
    const tourLabel=item.tour==="WTA"?"WTA":"ATP/CH";
    const metaA=item.a?`A: H ${fmt(item.a.predHold)} · B ${fmt(item.a.predBreak)} · C ${fmt(item.a.predCombined)}`:"";
    const metaB=item.b?`B: H ${fmt(item.b.predHold)} · B ${fmt(item.b.predBreak)} · C ${fmt(item.b.predCombined)}`:"";
    left.innerHTML=`
      <div class="title">${escapeHtml(item.title)}</div>
      <div class="meta">${tourLabel} · ${new Date(item.addedAt).toLocaleString()}</div>
      <div class="meta">${escapeHtml(metaA)}${metaB?`<br/>${escapeHtml(metaB)}`:""}</div>
    `;
    const actions=document.createElement("div");
    actions.className="actions";
    actions.innerHTML=`
      <span class="pill small" data-copy="${encodeURIComponent(item.title)}">⚡ Copy</span>
      <span class="pill small remove" data-remove="${encodeURIComponent(item.key)}">Remove</span>
    `;
    div.appendChild(left); div.appendChild(actions);
    todayListEl.appendChild(div);
  });

  todayListEl.querySelectorAll("[data-copy]").forEach(el=>{
    el.addEventListener("click", ()=>copyText(decodeURIComponent(el.getAttribute("data-copy")||"")));
  });
  todayListEl.querySelectorAll("[data-remove]").forEach(el=>{
    el.addEventListener("click", ()=>removeFromToday(decodeURIComponent(el.getAttribute("data-remove")||"")));
  });
}

/* Results render */
function render(matches){
  const thead=document.getElementById("thead");
  const tbody=document.getElementById("tbody");
  thead.innerHTML = `
    <tr>
      <th>Match</th><th></th>
      <th class="right">Pred Hold</th>
      <th class="right">Pred Break</th>
      <th class="right">Pred Combined</th>
      <th class="right">SPW</th>
      <th class="right">RPW</th>
    </tr>`;
  tbody.innerHTML="";

  matches.forEach((m, idx)=>{
    const title=matchTitle(m);
    const key=todayKeyForMatch(m);
    const already=TODAY.some(x=>x.key===key);

    const trH=document.createElement("tr");
    trH.className="match-row";
    trH.innerHTML=`
      <td colspan="7">
        <div class="match-title">
          <span>${escapeHtml(title)}</span>
          <span class="match-actions">
            <span class="pill small add" data-add="${idx}" ${already?'style="opacity:.55"':''}>${already?"Added ✓":"Add to Today"}</span>
            <span class="pill small" data-copytitle="${encodeURIComponent(title)}">⚡ Copy</span>
          </span>
        </div>
      </td>`;
    tbody.appendChild(trH);

    [m.a,m.b].forEach(s=>{
      if(!s) return;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><div class="player">${escapeHtml(s.player)}</div>${s.opponent?`<div class="muted">vs ${escapeHtml(s.opponent)}</div>`:""}</td>
        <td><span class="pill small" data-copy="${encodeURIComponent(s.player)}">⚡</span></td>
        <td class="right">${Number.isFinite(s.predHold)?s.predHold.toFixed(1):""}</td>
        <td class="right">${Number.isFinite(s.predBreak)?s.predBreak.toFixed(1):""}</td>
        <td class="right">${Number.isFinite(s.predCombined)?s.predCombined.toFixed(1):""}</td>
        <td class="right">${Number.isFinite(s.spw)?s.spw.toFixed(1):""}</td>
        <td class="right">${Number.isFinite(s.rpw)?s.rpw.toFixed(1):""}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  tbody.querySelectorAll("[data-copy]").forEach(el=>{
    el.addEventListener("click", ()=>copyText(decodeURIComponent(el.getAttribute("data-copy")||"")));
  });
  tbody.querySelectorAll("[data-copytitle]").forEach(el=>{
    el.addEventListener("click", ()=>copyText(decodeURIComponent(el.getAttribute("data-copytitle")||"")));
  });
  tbody.querySelectorAll("[data-add]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const i=parseInt(el.getAttribute("data-add"),10);
      if(Number.isFinite(i) && LAST_RENDERED_MATCHES[i]) addToToday(LAST_RENDERED_MATCHES[i]);
    });
  });

  document.getElementById("out").style.display="block";
}

/* export */
function downloadCSV(rows, filename){
  if(!rows.length){ showToast("Nothing to export"); return; }
  const headers=Object.keys(rows[0]);
  const esc=v=>{
    const s=String(v??"");
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const lines=[headers.map(esc).join(",")];
  rows.forEach(r=>lines.push(headers.map(h=>esc(r[h])).join(",")));
  const blob=new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function toExportRows(matches){
  const rows=[];
  matches.forEach(m=>{
    cons
